{% load static %}

<script>
    const sectionForm = document.getElementById('section-form');
    let current_user = {% if user.username == user_profile.user.username  and user.is_authenticated %} true {% else %}false {% endif %}
    console.log(current_user);

    sectionForm.addEventListener("submit", submitSectionHandler);
    function submitSectionHandler(e){
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '{% url 'create-section' pk=experience.pk %}',
            data: $("#section-form").serialize(),
            dataType: 'json',
            success: function (response) {
                if(!response.fail){
                    try {
                        document.getElementById('no-section').remove();
                    }catch {}



                    var section = '<div class="sub-section" id="sub-section-'+response.section_pk+'">\n' +
                        '            <div class="sub-section-header">\n' +
                        '                 <div class="sub-section-heading">\n' +
                        '                    <h4 class="sub-section-heading-text" id="sub-section-'+response.section_pk+'-name">\n' +
                                                response.name +
                        '                    </h4>\n' +
                        '                </div>\n' +
                        '                <button type="button" data-toggle="modal" data-target="#add-experience-specific-' + response.section_pk  + '" class="sub-section-button"><i class="fas fa-plus"></i></button>\n' +
                        '            </div>\n' +
                        '            <div class="modal fade" id="add-experience-specific-' + response.section_pk  + '" tabindex="-1" aria-labelledby="add-experience-specificLabel" aria-hidden="true">\n' +
                        '                <div class="modal-dialog">\n' +
                        '                    <div class="modal-content">\n' +
                        '                        <div class="modal-header">\n' +
                        '                            <h5 class="modal-title" id="add-experience-specificLabel">Add an ' + response.name  + ' </h5>\n' +
                        '                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n' +
                        '                                <span aria-hidden="true">&times;</span>\n' +
                        '                            </button>\n' +
                        '                        </div>\n' +
                        '                        <div class="modal-body">\n' +
                        '\n' +
                        '                            <form method="post" id="specific-form-' + response.section_pk  + '"  class="specific-form">\n' +
                        '                                {% csrf_token %}\n' +
                        '                                <div class="form-group row">\n' +
                        '                                    <label for="id_position" class="col-sm-2 col-form-label">Position: </label>\n' +
                        '                                    <div class="col-sm-10">\n' +
                        '                                        {{ specificForm.position }}\n' +
                        '                                    </div>\n' +
                        '                                </div>\n' +
                        '                                <div class="form-group row">\n' +
                        '                                    <label for="id_company" class="col-sm-2 col-form-label">Company: </label>\n' +
                        '                                    <div class="col-sm-10">\n' +
                        '                                        {{ specificForm.company }}\n' +
                        '                                    </div>\n' +
                        '                                </div>\n' +
                        '                                <div class="form-group">\n' +
                        '                                    <label for="id_company" class="col-form-label">Description: </label>\n' +
                        '                                    {{ specificForm.description }}\n' +
                        '                                </div>\n' +
                        '                                <div class="form-group row">\n' +
                        '                                    <label for="id_company" class="col-sm-2 col-form-label">Link: </label>\n' +
                        '                                    <div class="col-sm-10">\n' +
                        '                                        {{ specificForm.link }}\n' +
                        '                                    </div>\n' +
                        '                                </div>\n' +
                        '                              <button type="submit" class="btn btn-primary specific-form-submit">Add</button>\n' +
                        '\n' +
                        '                            </form>\n' +
                        '\n' +
                        '                        </div>\n' +
                        '                    </div>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="sub-section-container" id="sub-section-container">\n' +
                        '                <ul id="sub-section-list-' + response.section_pk +'" class="list-unstyled">\n' +
                        '                            <li style="background-color: transparent" class="card" id="no-specific">\n' +
                        '                              <div class="card-body">\n' +
                        '                                Click on + to add a(n) ' + response.name  + '\n' +
                        '                              </div>\n' +
                        '                            </li>\n' +
                        '                </ul>\n' +
                        '            </div>\n' +
                        '        </div>';

                     $("#experience-container").append(section);
                     var elem_id = "specific-form-" + response.section_pk;

                     var newForm = document.getElementById(elem_id);
                     newForm.addEventListener("submit", submitSpecificHandler);

                }
            }
        })
    }
    var specificForms = document.getElementsByClassName("specific-form");
      for (i = 0; i < specificForms.length; i++) {
        specificForms[i].addEventListener("submit", submitSpecificHandler);
      }

    {#$(document).on('submit', 'form.specific-form', submitSpecificHandler);#}
    function submitSpecificHandler(e){
        e.preventDefault();
        var form_id = this.id;
        var sec_pk = form_id.substring('specific-form-'.length);
        var url = '{% url 'specific-url' %}/'  + sec_pk;
        console.log('Test: ' + form_id +' '+ sec_pk+ ' : '+url);
        $.ajax({
            type: 'POST',
            url: url,
            data: $('#'+form_id).serialize(),
            dataType: 'json',
            success: function (response) {
                if(!response.fail){

                    try {
                        document.getElementById('no-specific').remove();
                     }catch {}

                    var specific = '<li class="media" style="margin: 10px 10px 18px 10px" id="specific-'+response.experience_pk+'">\n';
                        {#specific + '                                <img src="{{ specific.image.url }}" class="mr-3" alt="..." width="250" height="200">\n' +#}
                        specific += '<div class="media-body">\n';
                        specific += ' <h5 class="mt-0 mb-1" id="specific-'+response.experience_pk+'-position"> '+ response.position +'</h5>\n';
                        if (response.company != '' && response.company != 'None'){
                            specific += '<h7 class="mt-0 mb-1" id="specific-'+response.experience_pk+'-company">'+ response.company +'</h7>\n';
                        }
                         specific += '<p style="margin-bottom: 3px" id="specific-'+response.experience_pk+'-description">\n' + response.description +'\n'+ '</p>\n';
                        if (response.link != ''){
                            specific+='<a href="'+ response.link +'" class="btn btn-outline-danger" id="specific-'+response.experience_pk+'-link">Link</a>\n';
                            }
                        specific += '</div>\n' + '</li>';

                $("#sub-section-list-"+sec_pk).append(specific);

                }
            }
        })
    }



    const educationForm = document.getElementById('education-form');
educationForm.addEventListener("submit", submitEducationHandler);
function submitEducationHandler(e){
    e.preventDefault();
    $.ajax({
        type: 'POST',
        url: '{% url 'create-education' pk=user_profile.pk %}',
        data: $("#education-form").serialize(),
        dataType: 'json',
        success: function (response) {
            if(!response.fail){
                try {
                    document.getElementById('no-education').remove();
                }catch {}

                var education = '<div class="card mb-3 marg-20 edu-card" id="education-'+response.education_pk+'" style="width: 540px;border-radius: 1rem">\n' +
                    '        <div class="row no-gutters">\n' +
                    '{#            <div class="col-md-4">#}\n' +
                    '{#                <img src="{{ education.image }}" class="card-img" alt="edu-logo">#}\n' +
                    '{#            </div>#}\n' +
                    '            <div class="col-md-12">\n' +
                    '\n' +
                        '                    <div class="dropdown ">\n'+
                        '                        <button type="button" class="option-button" id="uni-Button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                        '                            <i class="fas fa-ellipsis-v"></i>\n'+
                        '                        </button>\n'+
                        '\n'+
                        '                         <div class="dropdown-menu" aria-labelledby="uni-Button">\n'+
                        '                            <button class="dropdown-item"  data-toggle="modal" data-target="#edit_education_card_'+response.education_pk+'">Edit</button>\n' +
                        '                            <form method="post" id="remove-education-'+response.education_pk+'-form" class="delete-object-form">\n' +
                        '                                {% csrf_token %} \n'+
                        '                                ' + '{{ deleteEducationForm.as_p }}' + ' \n'+
                        '                                <button type="submit" class="dropdown-item"> Remove </button>\n'+
                        '                            </form>\n'+
                        '                        </div>\n'+
                        '                    </div>\n'+
                        '\n'+
                        '                    <div class="modal fade" id="edit_education_card_'+response.education_pk+'" tabindex="-1" aria-labelledby="edit_cardLabel" aria-hidden="true">\n' +
                        '                        <div class="modal-dialog">\n'+
                        '                            <div class="modal-content">\n'+
                        '\n'+
                        '                                <div class="modal-header">\n'+
                        '                                    <h5 class="modal-title" id="edit_education_cardLabel_'+response.education_pk+'">Edit Education card</h5>\n' +
                        '                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n' +
                        '                                        <span aria-hidden="true">&times;</span>\n'+
                        '                                    </button>\n'+
                        '                                </div>\n'+
                        '\n'+
                        '                                <div class="modal-body">\n'+
                        '                                   <form method="post" id="edit-education-'+response.education_pk+'-form" class="edit-object-form">\n'+
                        '                                            {% csrf_token %} \n' +
                        '<p><label for="id_institution">Institution:</label> <input type="text" name="institution" maxlength="50" required id="id_institution"></p>'+
                        '<p><label for="id_certification_name">Certification name:</label> <input type="text" name="certification_name" maxlength="50" required id="id_certification_name"></p>'+
                        '<p><label for="id_description">Description:</label> <input type="text" name="description" maxlength="280" required id="id_description"></p>'+
                        '<p><label for="id_month">Month:</label> <input type="text" name="month" value="01" maxlength="2" required id="id_month"></p>'+
                        '<p><label for="id_year">Year:</label> <input type="text" name="year" value="9999" maxlength="4" required id="id_year"></p>'+
                        '                                       <button type="submit"> Edit </button>\n'+
                        '                                   </form>\n'+
                        '                                </div>\n'+
                        '\n'+
                        '                            </div>\n'+
                        '                        </div>\n'+
                        '                    </div>\n'+
                    '\n' +
                    '\n' +
                    '                <div class="card-body">\n';

                    if(response.institution != '' && response.institution != 'None'){
                           education += '                        <h5 id="education-'+response.education_pk+'-institution" class="card-text uniname">'+ response.institution +'</h5>\n';
                    }
                    education += '                    <h6 id="education-'+response.education_pk+'-certification_name" class="card-title major"> '+ response.certification_name +'</h6>\n';
                    if(response.description != '' && response.description != 'None'){
                        education += '                        <h6 id="education-'+response.education_pk+'-description" class="card-text edu-description">'+ response.description +'</h6>\n';
                    }
                    education += '                    <p id="education-'+response.education_pk+'-date" class="card-text"><small class="text-muted year">Date: '+ response.month +'/'+ response.year +'</small></p>\n' +
                    '                </div>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '\n' +
                    '    </div>';

                $("#education-container").append(education);
                 var elem_id = "edit-education-" + response.education_pk +"-form";
                 var newForm = document.getElementById(elem_id);
                 newForm.addEventListener("submit", submitEditHandler);

                 elem_id = 'remove-education-'+response.education_pk+'-form';
                 newForm = document.getElementById(elem_id);
                 newForm.addEventListener("submit", submitDeleteHandler);
            }
        }
    })
}

    const skillForm = document.getElementById('skill-form');

    skillForm.addEventListener("submit", submitSkillHandler);
    function submitSkillHandler(e){
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '{% url 'create-skill' pk=user_profile.pk %}',
            data: $("#skill-form").serialize(),
            dataType: 'json',
            success: function (response) {
                if(!response.fail){

                    try {
                        document.getElementById('no-skill').remove();
                    }catch {}

                    var skill = '<div class="card text-white bg-success mb-3" style="max-width: 18rem;" id="skill-'+response.skill_pk+'">\n' +
                        '        <div class="card-header" id="skill-'+response.skill_pk+'-name">'+ response.name +'</div>\n    </div>';

                    $("#skills-container").append(skill);

                }
            }
        })
    }

    const projectForm = document.getElementById('project-form');

    projectForm.addEventListener("submit", submitProjectHandler);
    function submitProjectHandler(e){
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '{% url 'create-project' pk=user_profile.pk %}',
            data: $("#project-form").serialize(),
            dataType: 'json',
            success: function (response) {
                if(!response.fail){
                    try {
                        document.getElementById('no-project').remove();
                    }catch {}

                    var project = '<div class="card" id="project-'+response.project_pk+'">\n' +
                        '        <div class="card-header" id="project-'+response.project_pk+'-name">\n' + response.name +
                        '        </div>\n' +
                        '        <div class="card-body">\n' +
                        '            <blockquote class="blockquote mb-0">\n' +
                        '                <p id="project-'+response.project_pk+'-description">' + response.description + '</p>\n' +
                        '                <footer class="blockquote-footer" id="project-'+response.project_pk+'-date">\n';

                    if (response.month != ''){
                        project += response.month +'/';
                    }

                    project += response.year + '\n' +
                        '                </footer>\n' +
                        '            </blockquote>\n' +
                        '        </div>\n' +
                        '    </div>';
                    console.log(project);
                    $("#projects-container").append(project);

                }else{alert('Form was not filled in correctly, please enter the required information')}
            }
        })
    }

    var deletionForms = document.getElementsByClassName("delete-object-form");
    for (i = 0; i < deletionForms.length; i++) {
        deletionForms[i].addEventListener("submit", submitDeleteHandler);
      }
    console.log('{% url 'delete-education' pk=1%}');
    function submitDeleteHandler(e){
        e.preventDefault();
        var form_id = this.id;
        var split_string = form_id.split("-");
        var obj_type = split_string[1];
        var obj_pk = split_string[2];
        if(obj_type == 'education'){
            var url = '{% url 'delete-education' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }else if(obj_type == 'section'){
             var url = '{% url 'delete-section' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }else if(obj_type == 'specific'){
             var url = '{% url 'delete-specific' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }else if(obj_type == 'skill'){
             var url = '{% url 'delete-skill' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }else if(obj_type == 'project'){
            var url = '{% url 'delete-project' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }
        $.ajax({
            type: 'POST',
            url: url,
            data: $('#'+form_id).serialize(),
            dataType: 'json',
            success: function (response) {
                if(!response.fail){
                    if (obj_type == 'section'){
                        $("#sub-"+obj_type+'-'+obj_pk).remove();
                    }else{
                        $("#"+obj_type+'-'+obj_pk).remove();
                    }

                }
            }
        })
    }

    var editForms = document.getElementsByClassName("edit-object-form");
    for (i = 0; i < editForms.length; i++) {
        editForms[i].addEventListener("submit", submitEditHandler);
      }
    function submitEditHandler(e){
        e.preventDefault();
        var form_id = this.id;
        var split_string = form_id.split("-");
        var obj_type = split_string[1];
        var obj_pk = split_string[2];
        if(obj_type == 'education'){
            var url = '{% url 'edit-education' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }else if(obj_type == 'section'){
             var url = '{% url 'edit-section' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }else if(obj_type == 'specific'){
             var url = '{% url 'edit-specific' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }else if(obj_type == 'skill'){
             var url = '{% url 'edit-skill' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }else if(obj_type == 'project'){
            var url = '{% url 'edit-project' pk=1%}';
            url = url.slice(0, -1) + obj_pk;
        }
        $.ajax({
            type: 'POST',
            url: url,
            data: $('#'+form_id).serialize(),
            dataType: 'json',
            success: function (response) {
                if(!response.fail){
                    console.log('Edit form sent');
                    if (obj_type == 'section'){
                        document.getElementById(obj_type+'-'+obj_pk+'-'+'name').innerText = response.name;

                    }else if (obj_type == 'specific'){
                        document.getElementById(obj_type+'-'+obj_pk+'-'+'position').innerText = response.position;
                        if(response.company != '' && response.company != 'None') {
                            document.getElementById(obj_type + '-' + obj_pk + '-' + 'company').innerText = response.company;
                        }
                        document.getElementById(obj_type+'-'+obj_pk+'-'+'description').innerText = response.description;
                        if(response.link != '' && response.link != 'None'){
                            document.getElementById(obj_type+'-'+obj_pk+'-'+'date').href = response.link;
                        }

                    }else if (obj_type == 'education'){
                        if(response.institution != '' && response.institution != 'None') {
                            document.getElementById(obj_type + '-' + obj_pk + '-' + 'institution').innerText = response.institution;
                        }
                        document.getElementById(obj_type+'-'+obj_pk+'-'+'certification_name').innerText = response.certification_name;
                        if(response.description != '' && response.description != 'None') {
                            document.getElementById(obj_type + '-' + obj_pk + '-' + 'description').innerText = response.description;
                        }
                        document.getElementById(obj_type+'-'+obj_pk+'-'+'date').innerText = 'Date:' + response.month +'/'+ response.year;

                    }else if (obj_type == 'skill'){
                        document.getElementById(obj_type+'-'+obj_pk+'-'+'name').innerText = response.name;

                    }else if (obj_type == 'project'){
                        document.getElementById(obj_type+'-'+obj_pk+'-'+'name').innerText = response.name;
                        document.getElementById(obj_type+'-'+obj_pk+'-'+'description').innerText = response.description;
                        if(response.month != '' && response.month != 'None') {
                            document.getElementById(obj_type + '-' + obj_pk + '-' + 'month').innerText = response.month / response.year;
                        }else{
                            document.getElementById(obj_type + '-' + obj_pk + '-' + 'month').innerText = response.year;

                        }



                    }

                }
            }
        })
    }
</script>